<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Teekeet Store | Turn Travel Tickets into Rewards</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  
  <!-- CSS Styles Inlined -->
  <style>
    :root {
      --bg: #fff7ef;
      --accent: #ffd54f;
      --accent-hover: #ffca28;
      --muted: #f4e9dd;
      --card: #fff;
      --text: #222;
      --text-light: #666;
      --brand: #ef6c00;
      --brand-dark: #e65100;
      --brand-gradient: linear-gradient(135deg, #ef6c00 0%, #f57f17 100%);
      --success: #4caf50;
      --error: #e53935;
      --warning: #ff9800;
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-md: 0 4px 20px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 40px rgba(0,0,0,0.15);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 20px;
      --radius-xl: 28px;
      font-family: "Inter", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
    }
    
    * { box-sizing: border-box; }
    
    html, body {
      height: 100%;
      margin: 0;
      background: linear-gradient(180deg, #fffaf5 0%, #fff3e0 100%);
      color: var(--text);
      padding-bottom: 80px;
      -webkit-font-smoothing: antialiased;
    }
    
    body.drawer-open { overflow: hidden; position: fixed; width: 100%; }
    
    /* HEADER */
    .topbar {
      display: flex; align-items: center; justify-content: space-between; padding: 12px 16px;
      background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      position: sticky; top: 0; z-index: 40; border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    
    .hamburger {
      width: 44px; height: 44px; border-radius: var(--radius-md); border: none; background: #fff;
      box-shadow: var(--shadow-sm); cursor: pointer; display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 5px; padding: 10px; transition: all 0.3s;
    }
    .hamburger-line { width: 20px; height: 2.5px; background: var(--brand); border-radius: 2px; }
    
    .logo { width: 42px; height: 42px; border-radius: var(--radius-md); object-fit: cover; }
    .brand-title { font-weight: 800; font-size: 18px; color: var(--brand); margin-left: 10px; }
    .center, .right { display: flex; align-items: center; } .right { gap: 10px; }
    
    .btn-login {
      background: var(--brand-gradient); color: white; border: none; padding: 10px 20px;
      border-radius: var(--radius-xl); font-weight: 700; font-size: 14px; cursor: pointer;
    }
    
    .balance-display {
      background: #fff; padding: 8px 14px; border-radius: var(--radius-xl); border: 2px solid var(--accent);
      font-weight: 800; color: var(--brand); font-size: 14px; display: flex; align-items: center; gap: 6px;
    }
    .refresh-btn { border: none; background: transparent; cursor: pointer; color: #999; }
    .spinning { animation: spin 0.8s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
  
    /* DRAWER */
    .drawer {
      position: fixed; top: 0; left: 0; width: 300px; height: 100vh; background: white; z-index: 100;
      box-shadow: var(--shadow-lg); transform: translateX(-100%); transition: transform 0.3s;
      display: flex; flex-direction: column;
    }
    .drawer.open { transform: translateX(0); }
    .drawer-inner { flex: 1; overflow-y: auto; }
    
    .drawer-close { position: absolute; top: 16px; right: 16px; width: 36px; height: 36px; border-radius: 50%; border: none; background: #f5f5f5; cursor: pointer; }
    
    .drawer-user-section { padding: 24px 20px; background: linear-gradient(135deg, #fff8e1 0%, #fff3e0 100%); }
    .drawer-avatar { width: 56px; height: 56px; border-radius: 50%; border: 3px solid white; object-fit: cover; }
    .drawer-login-btn { background: var(--brand-gradient); color: white; border: none; padding: 12px 24px; border-radius: var(--radius-xl); font-weight: 700; cursor: pointer; margin-top: 10px; }
    
    .nav-item { display: flex; align-items: center; width: 100%; padding: 14px 20px; background: none; border: none; font-size: 15px; cursor: pointer; color: var(--text); text-align: left; }
    .nav-item:hover { background: #fafafa; }
    .nav-icon { width: 28px; font-size: 18px; text-align: center; margin-right: 10px; }
    
    /* MAIN CONTENT */
    .container { padding: 16px; max-width: 1100px; margin: 0 auto; }
    
    .hero-banner {
      background: var(--brand-gradient); border-radius: var(--radius-lg); padding: 28px 24px;
      margin-bottom: 24px; color: white; text-align: center; position: relative; overflow: hidden;
    }
    .hero-banner h1 { margin: 0 0 10px; font-size: 26px; font-weight: 800; }
    .btn-hero { background: white; color: var(--brand); border: none; padding: 14px 28px; border-radius: var(--radius-xl); font-weight: 700; font-size: 16px; cursor: pointer; margin-top: 10px; }
    
    .search { width: 100%; padding: 14px; border-radius: var(--radius-md); border: 2px solid #eee; font-size: 15px; }
    .category-scroll { display: flex; gap: 8px; overflow-x: auto; padding: 10px 0; }
    .pill { background: white; border: 2px solid #eee; padding: 8px 16px; border-radius: var(--radius-xl); cursor: pointer; white-space: nowrap; }
    .pill.active { background: var(--brand); color: white; border-color: var(--brand); }
    
    /* GALLERY */
    .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
    .card { background: white; border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s; }
    .card:hover { transform: translateY(-4px); }
    .card-image { width: 100%; height: 180px; object-fit: cover; background: #eee; }
    .card-body { padding: 16px; position: relative; }
    .card-title { font-weight: 700; font-size: 16px; margin-bottom: 8px; }
    .card-store { font-size: 11px; color: var(--brand); font-weight: 700; text-transform: uppercase; }
    .card-points { position: absolute; top: -190px; right: 10px; background: white; padding: 4px 10px; border-radius: 20px; font-weight: bold; color: var(--brand); }
    
    /* MODALS & PANELS */
    .panel {
      position: fixed; top: 0; right: 0; height: 100%; width: 100%; max-width: 420px; background: white; z-index: 70;
      box-shadow: -5px 0 30px rgba(0,0,0,0.15); transform: translateX(100%); transition: transform 0.3s; display: flex; flex-direction: column;
    }
    .panel.open { transform: translateX(0); }
    .panel-header { padding: 16px; border-bottom: 1px solid #eee; display: flex; align-items: center; }
    .panel-back { background: #f5f5f5; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; margin-right: 10px; }
    .panel-scroll { flex: 1; overflow-y: auto; padding: 20px; }
    
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 80; display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
    .modal.open { opacity: 1; pointer-events: auto; }
    .modal-card { background: white; width: 100%; max-width: 400px; border-radius: var(--radius-lg); max-height: 90vh; overflow-y: auto; padding: 20px; position: relative; }
    .modal-close { position: absolute; top: 15px; right: 15px; background: #f5f5f5; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; }
    
    .btn-yellow { background: var(--accent); color: #111; border: none; padding: 14px; width: 100%; border-radius: var(--radius-md); font-weight: 700; cursor: pointer; margin-top: 10px; }
    
    .file-upload-area { border: 2px dashed #ddd; padding: 30px; text-align: center; border-radius: var(--radius-md); position: relative; }
    .file-upload-area input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
    
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; display: none; }
    .overlay.show { display: block; }
    
    .hidden { display: none !important; }
    
    .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 30px; z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
    .toast.show { opacity: 1; }
    .toast.success { background: var(--success); } .toast.error { background: var(--error); }
    
    @media (max-width: 768px) {
      .desktop-only { display: none; }
      .mobile-bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 10px; z-index: 45; border-top: 1px solid #eee; }
      .btn-block-upload { width: 100%; background: var(--brand-gradient); color: white; border: none; padding: 14px; border-radius: var(--radius-md); font-weight: 700; }
    }
    @media (min-width: 769px) { .mobile-bottom-bar { display: none; } }
  </style>

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>
  <div id="app">
    <!-- Overlay for Drawer/Panels -->
    <div id="overlay" class="overlay"></div>

    <!-- Header -->
    <header class="topbar">
      <div class="left">
        <button id="hamburger" class="hamburger">
          <span class="hamburger-line"></span><span class="hamburger-line"></span><span class="hamburger-line"></span>
        </button>
      </div>
      <div class="center">
        <span class="brand-title">Teekeet Store</span>
      </div>
      <div class="right">
        <div id="balanceDisplay" class="balance-display hidden">
          <span>üé´</span> <span id="userBalance">0</span>
          <button id="refreshBalance" class="refresh-btn">‚Üª</button>
        </div>
        <button id="authBtn" class="btn-login desktop-only">Login</button>
      </div>
    </header>

    <!-- Drawer Menu -->
    <aside id="drawer" class="drawer">
      <div class="drawer-inner">
        <button id="closeDrawer" class="drawer-close">‚úï</button>
        <div class="drawer-user-section">
          <div id="drawerLoggedOut">
            <h3>Welcome!</h3>
            <button id="drawerLoginBtn" class="drawer-login-btn">Login with Google</button>
          </div>
          <div id="drawerLoggedIn" class="hidden">
            <img id="drawerUserPhoto" class="drawer-avatar" src="" />
            <h3 id="drawerUserName">User</h3>
            <p id="drawerUserEmail">...</p>
          </div>
        </div>
        <nav style="padding: 10px 0;">
          <button id="menuHome" class="nav-item"><span class="nav-icon">üè†</span> Home</button>
          <button id="menuUploads" class="nav-item hidden"><span class="nav-icon">üé´</span> My Tickets</button>
          <button id="menuProfile" class="nav-item hidden"><span class="nav-icon">üë§</span> Profile</button>
          <button id="menuReferral" class="nav-item hidden"><span class="nav-icon">üéÅ</span> Refer & Earn</button>
          <button id="menuLogout" class="nav-item hidden" style="color:red;"><span class="nav-icon">üö™</span> Logout</button>
        </nav>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="container">
      <section class="hero-banner">
        <h1>Turn Tickets into Rewards üé´</h1>
        <p>Upload bus/train tickets & earn coupons!</p>
        <button id="heroUploadBtn" class="btn-hero">Upload Ticket</button>
      </section>

      <div class="search-wrapper">
        <input id="searchInput" placeholder="Search stores..." class="search" />
      </div>
      <div id="categoryPills" class="category-scroll"></div>
      
      <section id="gallery" class="gallery">
        <!-- Coupons inject here -->
      </section>
    </main>

    <!-- Mobile Bottom Bar -->
    <div class="mobile-bottom-bar">
      <button id="mobileBottomUpload" class="btn-block-upload">üì∑ Upload Ticket</button>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="modal">
      <div class="modal-card">
        <button id="closeUpload" class="modal-close">‚úï</button>
        <h3>üì∑ Upload Ticket</h3>
        <form id="uploadForm">
          <input id="formName" type="text" placeholder="Your Name" class="search" style="margin-bottom:10px" required />
          <input id="formReferral" type="text" placeholder="Referral Code (Optional)" class="search" style="margin-bottom:10px" />
          
          <div class="file-upload-area" id="fileArea">
            <input id="fileInput" type="file" accept="image/*" required />
            <span style="font-size:24px">üìÑ</span>
            <p>Tap to select image</p>
          </div>
          <img id="imgPreview" style="width:100%; margin-top:10px; border-radius:8px; display:none" />
          
          <button type="button" id="submitUpload" class="btn-yellow">üöÄ Submit</button>
        </form>
      </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="modal">
      <div class="modal-card">
        <button id="closeDetail" class="modal-close">‚úï</button>
        <div id="detailContent"></div>
      </div>
    </div>

    <!-- Panels (Profile, History, etc.) -->
    <section id="uploadsPanel" class="panel">
      <div class="panel-header">
        <button class="panel-back" onclick="closePanels()">‚Üê</button> <h4>My Tickets</h4>
      </div>
      <div id="uploadsList" class="panel-scroll"></div>
    </section>

    <!-- Toast -->
    <div id="toast" class="toast"></div>
  </div>

  <script>
    /* ==================== CONFIGURATION ==================== */
    
    // 1. PASTE YOUR GOOGLE APPS SCRIPT WEB APP URL HERE
    const GAS_API_URL = "YOUR_WEB_APP_URL_HERE"; 
    
    // 2. Firebase Config will be fetched dynamically, or you can paste it here to be faster
    var firebaseConfig = null;

    /* ==================== APP LOGIC ==================== */
    var currentUser = null;
    var idToken = null;
    var allCoupons = [];
    
    // DOM Elements
    const els = {
      drawer: document.getElementById('drawer'),
      overlay: document.getElementById('overlay'),
      gallery: document.getElementById('gallery'),
      authBtn: document.getElementById('authBtn'),
      drawerLogin: document.getElementById('drawerLoginBtn'),
      fileInput: document.getElementById('fileInput'),
      toast: document.getElementById('toast')
    };

    function init() {
      setupEventListeners();
      
      // Fetch Config & Coupons
      callApi('getFirebaseConfig').then(cfg => {
        if(cfg && cfg.apiKey) {
          if(firebase.apps.length === 0) firebase.initializeApp(cfg);
          firebase.auth().onAuthStateChanged(user => {
            currentUser = user;
            updateUI();
            if(user) user.getIdToken().then(t => { idToken = t; fetchUserData(); });
          });
        }
      });

      callApi('getAllCoupons').then(list => {
        allCoupons = list || [];
        renderCoupons(allCoupons);
      });
    }

    /* --- API HELPER (REPLACES google.script.run) --- */
    async function callApi(action, data = {}) {
      if(!GAS_API_URL.startsWith("http")) {
        console.error("Please configure GAS_API_URL in index.html");
        showToast("App not configured", "error");
        return null;
      }

      const payload = { action: action, data: data, idToken: idToken };
      
      try {
        const response = await fetch(GAS_API_URL, {
          method: "POST",
          body: JSON.stringify(payload),
          headers: { "Content-Type": "text/plain" } // Avoid CORS Preflight
        });
        const json = await response.json();
        return json;
      } catch (e) {
        console.error("API Error", e);
        // showToast("Network Error", "error");
        return null;
      }
    }

    /* --- UI FUNCTIONS --- */
    function setupEventListeners() {
      document.getElementById('hamburger').onclick = () => { els.drawer.classList.add('open'); els.overlay.classList.add('show'); };
      document.getElementById('closeDrawer').onclick = closeDrawer;
      els.overlay.onclick = closeDrawer;
      
      els.authBtn.onclick = handleLogin;
      els.drawerLogin.onclick = handleLogin;
      document.getElementById('menuLogout').onclick = () => { firebase.auth().signOut(); closeDrawer(); };
      
      // Navigation
      document.getElementById('menuHome').onclick = () => { closeDrawer(); closePanels(); };
      document.getElementById('menuUploads').onclick = () => { closeDrawer(); openUploads(); };
      
      // Upload Flow
      const openUp = () => {
        if(!currentUser) { showToast("Login required", "error"); handleLogin(); return; }
        document.getElementById('uploadModal').classList.add('open');
        if(document.getElementById('formName')) document.getElementById('formName').value = currentUser.displayName || '';
      };
      document.getElementById('heroUploadBtn').onclick = openUp;
      document.getElementById('mobileBottomUpload').onclick = openUp;
      document.getElementById('closeUpload').onclick = () => document.getElementById('uploadModal').classList.remove('open');
      document.getElementById('closeDetail').onclick = () => document.getElementById('detailModal').classList.remove('open');

      document.getElementById('submitUpload').onclick = submitTicket;

      // File Preview
      els.fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if(file) {
          const r = new FileReader();
          r.onload = (ev) => { 
            document.getElementById('imgPreview').src = ev.target.result; 
            document.getElementById('imgPreview').style.display = 'block';
            document.getElementById('fileArea').style.display = 'none';
          };
          r.readAsDataURL(file);
        }
      };
      
      // Refresh Balance
      document.getElementById('refreshBalance').onclick = fetchUserData;
      
      // Search
      document.getElementById('searchInput').oninput = (e) => {
        const q = e.target.value.toLowerCase();
        renderCoupons(allCoupons.filter(c => c.store.toLowerCase().includes(q) || c.title.toLowerCase().includes(q)));
      };
    }

    function handleLogin() {
      const provider = new firebase.auth.GoogleAuthProvider();
      firebase.auth().signInWithPopup(provider).catch(e => showToast(e.message, 'error'));
    }

    function updateUI() {
      const loggedIn = !!currentUser;
      els.authBtn.style.display = loggedIn ? 'none' : 'block';
      document.getElementById('balanceDisplay').classList.toggle('hidden', !loggedIn);
      
      // Drawer
      document.getElementById('drawerLoggedOut').classList.toggle('hidden', loggedIn);
      document.getElementById('drawerLoggedIn').classList.toggle('hidden', !loggedIn);
      
      ['menuUploads', 'menuProfile', 'menuReferral', 'menuLogout'].forEach(id => {
        document.getElementById(id).classList.toggle('hidden', !loggedIn);
      });

      if(loggedIn) {
        document.getElementById('drawerUserPhoto').src = currentUser.photoURL || '';
        document.getElementById('drawerUserName').textContent = currentUser.displayName;
        document.getElementById('drawerUserEmail').textContent = currentUser.email;
      }
    }

    function closeDrawer() {
      els.drawer.classList.remove('open');
      els.overlay.classList.remove('show');
    }

    function closePanels() {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('open'));
    }

    function showToast(msg, type) {
      els.toast.textContent = msg;
      els.toast.className = `toast show ${type}`;
      setTimeout(() => els.toast.classList.remove('show'), 3000);
    }

    /* --- DATA LOGIC --- */
    function renderCoupons(list) {
      els.gallery.innerHTML = '';
      if(!list.length) { els.gallery.innerHTML = '<p style="text-align:center;width:100%">No coupons found</p>'; return; }
      
      list.forEach(c => {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <div style="position:relative">
            <img class="card-image" src="${convertImg(c.image)}" loading="lazy" />
            <div class="card-points">${c.points} pts</div>
          </div>
          <div class="card-body">
            <div class="card-store">${c.store}</div>
            <div class="card-title">${c.title}</div>
          </div>`;
        div.onclick = () => openDetail(c);
        els.gallery.appendChild(div);
      });
    }

    function openDetail(c) {
      const content = document.getElementById('detailContent');
      content.innerHTML = `
        <h2 style="margin-top:0">${c.store}</h2>
        <h3>${c.title}</h3>
        <p>${c.description || c.longOffer}</p>
        <p><strong>Terms:</strong> ${c.terms || '-'}</p>
        <button id="redeemBtn" class="btn-yellow">üéÅ Redeem (${c.points} pts)</button>
      `;
      
      document.getElementById('redeemBtn').onclick = async function() {
        if(!currentUser) { handleLogin(); return; }
        if(!confirm(`Redeem for ${c.points} points?`)) return;
        
        this.textContent = "Processing...";
        this.disabled = true;
        
        const res = await callApi('requestRedemptionSecure', { couponId: c.id });
        showToast(res.message, res.success ? 'success' : 'error');
        if(res.success) { 
           document.getElementById('detailModal').classList.remove('open');
           fetchUserData(); // Update balance
        } else {
           this.textContent = "Try Again";
           this.disabled = false;
        }
      };
      
      document.getElementById('detailModal').classList.add('open');
    }

    async function submitTicket() {
      if(!els.fileInput.files[0]) return showToast("Select an image", "error");
      
      const btn = document.getElementById('submitUpload');
      btn.textContent = "Compressing...";
      btn.disabled = true;

      // Compress Image (Simple implementation)
      const file = els.fileInput.files[0];
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = async () => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const maxDim = 1000; // Resize to max 1000px
          let w = img.width, h = img.height;
          if(w > h && w > maxDim) { h *= maxDim/w; w = maxDim; }
          else if(h > w && h > maxDim) { w *= maxDim/h; h = maxDim; }
          canvas.width = w; canvas.height = h;
          ctx.drawImage(img, 0, 0, w, h);
          
          btn.textContent = "Uploading...";
          const base64 = canvas.toDataURL('image/jpeg', 0.7);
          
          const payload = {
            base64: base64,
            fileName: file.name,
            name: document.getElementById('formName').value,
            referrerCode: document.getElementById('formReferral').value
          };
          
          const res = await callApi('uploadTicketSecure', payload);
          if(res && res.success) {
            showToast("Uploaded Successfully!", "success");
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            document.getElementById('uploadModal').classList.remove('open');
            document.getElementById('uploadForm').reset();
            document.getElementById('fileArea').style.display = 'block';
            document.getElementById('imgPreview').style.display = 'none';
          } else {
            showToast(res ? res.message : "Upload Failed", "error");
          }
          btn.textContent = "üöÄ Submit";
          btn.disabled = false;
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    async function fetchUserData() {
      const btn = document.getElementById('refreshBalance');
      btn.classList.add('spinning');
      
      const data = await callApi('getUserDataSecure');
      if(data) {
        document.getElementById('userBalance').textContent = data.balance || 0;
      }
      btn.classList.remove('spinning');
    }

    async function openUploads() {
      const panel = document.getElementById('uploadsPanel');
      panel.classList.add('open');
      const list = document.getElementById('uploadsList');
      list.innerHTML = '<p>Loading...</p>';
      
      const uploads = await callApi('getPreviousUploadsSecure');
      list.innerHTML = '';
      if(!uploads || !uploads.length) { list.innerHTML = '<p>No tickets yet.</p>'; return; }
      
      uploads.forEach(u => {
        const item = document.createElement('div');
        item.style.cssText = "padding:10px; border-bottom:1px solid #eee; display:flex; gap:10px";
        item.innerHTML = `
          <img src="${convertImg(u.photo)}" style="width:50px;height:50px;border-radius:4px;object-fit:cover;background:#eee" />
          <div>
             <div style="font-weight:bold">${u.status}</div>
             <div style="font-size:12px;color:#666">${new Date(u.uploadedAt).toLocaleDateString()}</div>
             <div style="font-size:12px;color:var(--brand)">${u.points} pts</div>
          </div>
        `;
        list.appendChild(item);
      });
    }

    function convertImg(url) {
      if(!url) return '';
      // Convert Google Drive Links to Viewable Links
      const idMatch = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/) || url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
      if(idMatch) return 'https://lh3.googleusercontent.com/d/' + idMatch[1];
      return url;
    }

    init();
  </script>
</body>
</html>
